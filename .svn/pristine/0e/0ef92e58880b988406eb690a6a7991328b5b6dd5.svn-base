/* NG APP */
var app = angular.module('formApp', ['ngAnimate', 'ui.router']);

/* ROUTES/VIEWS */
app.config(function($stateProvider, $urlRouterProvider) {
    
    $stateProvider
    
        /* MAIN FORM ROUTE */
        .state('form', {
            url: '/form',
            templateUrl: 'views/form.html',
            controller: 'formController'
        })
        
        /* NESTED PROFILE ROUTE */
        .state('form.profile', {
            url: '/profile',
            templateUrl: 'views/form-profile.html',
            controller: 'profileController'
        })
        
        /* NESTED CLASS ROUTE */
        .state('form.class', {
            url: '/class',
            templateUrl: 'views/form-class.html',
            controller: 'classController'
        })
        
        /* NESTED CONFIRM ROUTE */
        .state('form.confirm', {
            url: '/confirm',
            templateUrl: 'views/form-confirm.html'
        });    
    /* CATCH ALL ROUTE */
    $urlRouterProvider.otherwise('/form/profile');
});

/********************************************************************
* CONTROLLERS
********************************************************************/

/* MAIN FORM CONTROLLER*/
app.controller('formController', function($scope) {
    $scope.formData = {};
    
    /* FUNCTION TO PROCESS FORM */
    $scope.processForm = function(isValid) {
        console.log(isValid);
        if (isValid) {
            alert('valid');
        }
    }; 
});

/* PROFILE CONTROLLER*/
app.controller('profileController',function($scope,$http,$state){
    $scope.PHONE_REGEX = /^[(]{0,1}[0-9]{3}[)\.\- ]{0,1}[0-9]{3}[\.\- ]{0,1}[0-9]{4}$/;
    $scope.validate = function() {
        var fields = [
            $scope.userForm.username,
            $scope.userForm.company,
            $scope.userForm.email,
            $scope.userForm.phoneno,
            $scope.userForm.address,
            $scope.userForm.city,
            $scope.userForm.state,
            $scope.userForm.zipcode
        ];
        var invalid = 0;
        angular.forEach(fields,function(value,index){
            if (value.$invalid) {
                invalid = 1;
            }
        });
        if (invalid === 0) {
            $state.go('form.class');
        } else {
            alert('Please verify form is complete');
        }
    };
});

/* CLASS SELECTION CONTROLLER */
app.controller('classController',function($scope,$http){
    $scope.selectedClass = null;
    $scope.upcomingTraining = [];

    /* GET CURRENT CLASS NAMES */
    $http({
        method: 'GET',
        url: 'http://localhost:8081/api/currentclasses',
        data: {}
    }).success(function (result) {
        $scope.upcomingTraining = result;
    });

    /* SELECTED CLASS DROP DOWN HOOK */
    $scope.Selected = function() {

    }
    $scope.$watch('formData.selectedClass', function(newvalue,oldvalue) {
        $scope.formData.selectedDateTime = '';
        console.log(newvalue);
        if(newvalue !== undefined){getDateTimes(newvalue);}
    });

    /* POST SELECTED CLASS DATE/TIME */
    var getDateTimes = function(req,res){
        $scope.formselectedClassDateTime = null;
        $scope.upcomingTrainingDateTime = [];
        $http({
            method: 'POST',
            url: 'http://localhost:8081/api/classdatetime',
            data: {Class: req.Class}
        }).success(function (result) {
            $scope.upcomingTrainingDateTime = result;
            console.log(result);
        });
    };
});

/********************************************************************
* DIRECTIVES
********************************************************************/