/* MWA TRAINING/EVENT LIST API */
var express  	= require('express');	
var bodyParser 	= require("body-parser");								
var app     	= express(); 	
var nodemailer 	= require('nodemailer');										
var mysql 		= require('mysql'); 									
var port  	 	= 8081; 										
var database 	= require('./config/database');
var email		= require('./config/email');

app.use(bodyParser.json());

app.all('*', function(req, res, next) {
	res.set('Access-Control-Allow-Origin', 'file://');
	res.set('Access-Control-Allow-Credentials', true);
	res.set('Access-Control-Allow-Methods', 'GET, POST, DELETE, PUT');
	res.set('Access-Control-Allow-Headers', 'X-Requested-With, Content-Type');
	if ('OPTIONS' == req.method) return res.status(200).end();
	next();
});

var transporter = nodemailer.createTransport(email);

var mailOptions = {
    from: 'Corey Durthaler <cdurth@gmail.com>', // sender address
    to: 'corey.durthaler@martinandassoc.com,cdurth@gmail.com', // list of receivers
    subject: 'Hello ✔', // Subject line
    text: 'Hello world ✔', // plaintext body
    html: '<b>Hello world ✔</b>' // html body
};

/*transporter.sendMail(mailOptions, function(error, info){
    if(error){
        console.log(error);
    }else{
        console.log('Message sent: ' + info.response);
    }
});*/

/* CLASS LIST ROUTE */
app.get('/api/currentclasses', function(req, res) {
	var result = []; 

	var connection = mysql.createConnection(database);
	connection.connect(function(err) {
	  	if (err) {
		    console.error('error connecting: ' + err.stack);
		    return;
	  	}
	  console.log('connected as id ' + connection.threadId);
	});	

	var queryString = 'SELECT DISTINCT Class FROM UpcomingTraining';
	connection.query(queryString, function(err, rows, fields) {
	    if (err) throw err;
	 	
	    for (var i in rows) {
	       // console.log('ID: ', rows[i].id);
	        result.push({
	        	ID: rows[i].id,
	        	Class: rows[i].Class,
	        	StartDate: rows[i].StartDate,
	        	EndDate: rows[i].EndDate
	        });
	    }

		res.contentType('application/json');
		res.send(result);
	});

	connection.end();
	console.log('connection closed');

});

/* CLASS TIME ROUTE */
app.post('/api/classdatetime', function(req, res) {
	var result = []; 

	var connection = mysql.createConnection(database);
	connection.connect(function(err) {
	  	if (err) {
		    console.error('error connecting: ' + err.stack);
		    return;
	  	}
	  console.log('connected as id ' + connection.threadId);
	});	
	console.log(req.body);
	var queryString = "SELECT StartDate, EndDate FROM UpcomingTraining WHERE Class ='"+ req.body.Class +"'";
	connection.query(queryString, function(err, rows, fields) {
	    if (err) throw err;
	 	
	    for (var i in rows) {
	        console.log('Times: ', rows[i].StartDate);
	        result.push({
	        	ID: rows[i].id,
	        	Class: rows[i].Class,
	        	StartDate: rows[i].StartDate,
	        	EndDate: rows[i].EndDate
	        });
	    }

		res.contentType('application/json');
		res.send(result);
	});

	connection.end();
	console.log('connection closed');

});



/* LISTEN */
app.listen(port);
console.log("App listening on port " + port);

